<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jacie Streaming Chat Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .chat-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 15px;
            box-sizing: border-box;
        }
        .btn {
            background: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .btn:hover { background: #0056b3; }
        .btn:disabled { 
            background: #ccc; 
            cursor: not-allowed; 
        }
        .progress-container {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #007bff;
        }
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #007bff, #28a745);
            transition: width 0.3s ease;
            width: 0%;
        }
        .status-message {
            font-weight: 500;
            color: #333;
            margin-bottom: 5px;
        }
        .step-info {
            font-size: 14px;
            color: #666;
        }
        .response-container {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #28a745;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border-left-color: #dc3545;
        }
        .hidden { display: none; }
        .options {
            margin: 15px 0;
            padding: 15px;
            background: #e9ecef;
            border-radius: 6px;
        }
        .option {
            margin: 8px 0;
        }
        .option label {
            margin-left: 8px;
            font-weight: 500;
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .endpoint-selection {
            margin-bottom: 20px;
        }
        .endpoint-btn {
            background: #6c757d;
            margin-right: 10px;
        }
        .endpoint-btn.active {
            background: #007bff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ¤– Jacie Streaming Chat Test</h1>
        
        <div class="endpoint-selection">
            <button class="btn endpoint-btn active" onclick="selectEndpoint('chat')">Traditional Chat</button>
            <button class="btn endpoint-btn" onclick="selectEndpoint('fast_chat')">Fast Chat (Vector DB)</button>
        </div>
        
        <div class="options">
            <div class="option">
                <input type="checkbox" id="autoLoad" checked>
                <label for="autoLoad">Auto-load documents</label>
            </div>
            <div class="option">
                <input type="checkbox" id="memoryEnabled" checked>
                <label for="memoryEnabled">Enable memory (conversation history)</label>
            </div>
        </div>
        
        <textarea 
            class="chat-input" 
            id="queryInput" 
            placeholder="Ask a question about JSE documents..."
            rows="3"
        ></textarea>
        
        <button class="btn" onclick="startStreamingChat()" id="sendBtn">
            Send Message
        </button>
        <button class="btn" onclick="clearChat()" style="background: #6c757d;">
            Clear
        </button>
        
        <div class="progress-container hidden" id="progressContainer">
            <div class="status-message" id="statusMessage">Initializing...</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="step-info" id="stepInfo">Step: starting</div>
        </div>
        
        <div class="response-container hidden" id="responseContainer">
            <h3>Response:</h3>
            <div id="responseText"></div>
            <div id="responseDetails" style="margin-top: 15px; font-size: 14px; color: #666;"></div>
        </div>
    </div>

    <script>
        let currentEndpoint = 'chat';
        let conversationHistory = [];

        function selectEndpoint(endpoint) {
            currentEndpoint = endpoint;
            
            // Update button states
            document.querySelectorAll('.endpoint-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        function startStreamingChat() {
            const query = document.getElementById('queryInput').value.trim();
            if (!query) {
                alert('Please enter a question');
                return;
            }
            
            const autoLoad = document.getElementById('autoLoad').checked;
            const memoryEnabled = document.getElementById('memoryEnabled').checked;
            
            // Show progress, hide response
            document.getElementById('progressContainer').classList.remove('hidden');
            document.getElementById('responseContainer').classList.add('hidden');
            document.getElementById('sendBtn').disabled = true;
            
            // Reset progress
            updateProgress('start', 'Starting...', 0);
            
            // Prepare request data
            const requestData = {
                query: query,
                auto_load_documents: autoLoad,
                memory_enabled: memoryEnabled,
                conversation_history: memoryEnabled ? conversationHistory : null
            };
            
            // Start streaming
            const url = `http://localhost:8000/${currentEndpoint}/stream`;
            
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                function processStream() {
                    return reader.read().then(({ done, value }) => {
                        if (done) {
                            document.getElementById('sendBtn').disabled = false;
                            return;
                        }
                        
                        const chunk = decoder.decode(value);
                        const lines = chunk.split('\n');
                        
                        for (const line of lines) {
                            if (line.startsWith('event: ')) {
                                const event = line.substring(7);
                                continue;
                            }
                            if (line.startsWith('data: ')) {
                                const data = line.substring(6);
                                try {
                                    const parsed = JSON.parse(data);
                                    handleStreamEvent(event || 'unknown', parsed);
                                } catch (e) {
                                    // Ignore parse errors for heartbeats
                                }
                            }
                        }
                        
                        return processStream();
                    });
                }
                
                return processStream();
            })
            .catch(error => {
                console.error('Stream error:', error);
                showError(`Error: ${error.message}`);
                document.getElementById('sendBtn').disabled = false;
            });
        }
        
        function handleStreamEvent(event, data) {
            switch (event) {
                case 'progress':
                    updateProgress(data.step, data.message, data.progress, data.details);
                    break;
                case 'result':
                    showResult(data);
                    break;
                case 'error':
                    showError(data.error);
                    break;
                case 'heartbeat':
                    // Keep connection alive, do nothing
                    break;
            }
        }
        
        function updateProgress(step, message, progress, details) {
            document.getElementById('statusMessage').textContent = message;
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('stepInfo').textContent = `Step: ${step}`;
            
            if (details) {
                const detailsText = Object.entries(details)
                    .map(([key, value]) => `${key}: ${value}`)
                    .join(', ');
                document.getElementById('stepInfo').textContent += ` (${detailsText})`;
            }
        }
        
        function showResult(result) {
            document.getElementById('progressContainer').classList.add('hidden');
            document.getElementById('responseContainer').classList.remove('hidden');
            document.getElementById('responseContainer').classList.remove('error');
            
            document.getElementById('responseText').textContent = result.response;
            
            let details = [];
            if (result.documents_loaded && result.documents_loaded.length > 0) {
                details.push(`Documents loaded: ${result.documents_loaded.length}`);
            }
            if (result.document_selection_message) {
                details.push(`Selection: ${result.document_selection_message}`);
            }
            
            document.getElementById('responseDetails').textContent = details.join(' | ');
            
            // Update conversation history if memory is enabled
            if (document.getElementById('memoryEnabled').checked && result.conversation_history) {
                conversationHistory = result.conversation_history;
            }
            
            document.getElementById('sendBtn').disabled = false;
        }
        
        function showError(error) {
            document.getElementById('progressContainer').classList.add('hidden');
            document.getElementById('responseContainer').classList.remove('hidden');
            document.getElementById('responseContainer').classList.add('error');
            
            document.getElementById('responseText').textContent = `Error: ${error}`;
            document.getElementById('responseDetails').textContent = '';
            
            document.getElementById('sendBtn').disabled = false;
        }
        
        function clearChat() {
            document.getElementById('queryInput').value = '';
            document.getElementById('progressContainer').classList.add('hidden');
            document.getElementById('responseContainer').classList.add('hidden');
            conversationHistory = [];
        }
        
        // Enable Enter key to send message
        document.getElementById('queryInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                startStreamingChat();
            }
        });
    </script>
</body>
</html> 